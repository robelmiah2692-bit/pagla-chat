name: Build APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          cache: true

      - name: üõ†Ô∏è Final Firebase Fix
        run: |
          # ‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ JSON ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∞‡¶æ‡¶ñ‡¶æ
          cp android/app/google-services.json ./google-services.json.backup || true
          
          # ‡ß®. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶Ü‡¶™ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (‡¶Ø‡¶æ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶æ‡¶ï‡¶∏‡ßá‡¶∏ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
          sed -i 's/name: .*/name: pagla_chat/g' pubspec.yaml
          rm -rf android
          flutter create . --project-name pagla_chat --org com.pagla --platforms android
          
          # ‡ß©. ‡¶∞‡ßÅ‡¶ü ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá‡¶∞ build.gradle ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶™‡¶æ‡¶• ‡¶¨‡¶∏‡¶æ‡¶®‡ßã (‡¶≤‡¶ó‡¶á‡¶® ‡¶è‡¶∞‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏)
          cat <<EOF > android/build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies {
                  classpath 'com.android.tools.build:gradle:7.3.0'
                  classpath 'com.google.gms:google-services:4.3.15'
              }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF

          # ‡ß™. ‡¶ó‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶°‡¶≤ ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ
          cd android
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip" > gradle/wrapper/gradle-wrapper.properties
          
          # ‡ß´. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶á ‡¶ö‡¶ø‡¶∞‡¶ö‡ßá‡¶®‡¶æ ‡¶ï‡¶ø-‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ì ‡¶ú‡ßá‡¶è‡¶∏‡¶ì‡¶è‡¶® ‡¶´‡¶ø‡¶∞‡¶ø‡ßü‡ßá ‡¶Ü‡¶®‡¶æ
          mkdir -p app
          mv ../google-services.json.backup app/google-services.json || echo "No JSON"
          
          keytool -genkey -v -keystore app/upload-keystore.jks \
            -storepass "pagla123" -alias "pagla_alias" -keypass "pagla123" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Pagla, O=Chat, C=BD" -startdate "2024/01/01 00:00:00"

          # ‡ß¨. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ (‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶Ü‡¶á‡¶°‡¶ø com.pagla.chat ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ)
          sed -i 's/applicationId ".*"/applicationId "com.pagla.chat"/g' app/build.gradle
          sed -i 's/minSdkVersion .*/minSdkVersion 21/g' app/build.gradle
          echo "apply plugin: 'com.google.gms.google-services'" >> app/build.gradle
          
          chmod +x gradlew
          cd ..

      - name: Build APK (Release)
        run: |
          flutter pub get
          flutter build apk --release --no-tree-shake-icons

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PaglaChat-Final-Working
          path: build/app/outputs/flutter-apk/app-release.apk
