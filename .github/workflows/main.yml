name: Build APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          cache: true

      - name: üõ†Ô∏è Clean & Prep
        run: |
          # ‡ßß. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶è‡¶∞‡¶∞ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
          flutter clean
          flutter pub get

          # ‡ß®. ‡¶ï‡¶ø-‡¶∏‡ßç‡¶ü‡ßã‡¶∞ (Keystore) ‡¶§‡ßà‡¶∞‡¶ø (‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶è‡¶∞‡¶∞ ‡¶®‡¶æ ‡¶Ü‡¶∏‡ßá)
          mkdir -p android/app
          if [ ! -f android/app/upload-keystore.jks ]; then
            keytool -genkey -v -keystore android/app/upload-keystore.jks \
              -storepass "pagla123" -alias "pagla_alias" -keypass "pagla123" \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=Pagla, O=Chat, C=BD" \
              -startdate "2024/01/01 00:00:00"
          fi

          # ‡ß©. build.gradle ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (Package Name ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ)
          sed -i 's/applicationId "com.example.pagla_chat"/applicationId "com.pagla.chat"/g' android/app/build.gradle
          sed -i 's/minSdkVersion .*/minSdkVersion 21/g' android/app/build.gradle
          
          chmod +x android/gradlew

      - name: Build APK (Release)
        run: |
          # ‡ß™. ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ
          if [ -f android/app/google-services.json ]; then
            flutter build apk --release --no-tree-shake-icons
          else
            echo "‚ùå ‡¶≠‡ßÅ‡¶≤! google-services.json ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø android/app/ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PaglaChat-Fixed-Build
          path: build/app/outputs/flutter-apk/app-release.apk
