name: Build APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          cache: true

      - name: ðŸ› ï¸ Reconstruct (Old Working Style)
        run: |
          # à§§. à¦†à¦ªà¦¨à¦¾à¦° JSON à¦¬à§à¦¯à¦¾à¦•à¦†à¦ª à¦°à¦¾à¦–à¦¾
          cp android/app/google-services.json ./google-services.json.backup || true
          
          # à§¨. à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à¦¾à¦¤à¦¨ à¦•à§à¦²à¦¿à¦¨à¦†à¦ª à¦¸à§à¦Ÿà¦¾à¦‡à¦² (à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦¦à§‡à¦“à§Ÿà¦¾ à¦•à§‹à¦¡)
          sed -i 's/name: .*/name: pagla_chat/g' pubspec.yaml
          rm -rf android
          flutter create . --project-name pagla_chat --platforms android
          
          # à§©. à¦—à§à¦°à§à¦¯à¦¾à¦¡à¦² à¦­à¦¾à¦°à§à¦¸à¦¨ à¦«à¦¿à¦•à§à¦¸ (à¦¯à¦¾à¦¤à§‡ HasConvention à¦à¦°à¦° à¦¨à¦¾ à¦†à¦¸à§‡)
          # à¦à¦Ÿà¦¿ à¦•à¦°à¦²à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à¦¾à¦¤à¦¨ à¦¸à§à¦Ÿà¦¾à¦‡à¦²à¦“ à¦¬à¦œà¦¾à§Ÿ à¦¥à¦¾à¦•à¦¬à§‡, à¦¬à¦¿à¦²à§à¦¡à¦“ à¦ªà¦¾à¦¸ à¦¹à¦¬à§‡
          cd android
          gradle wrapper --gradle-version 7.6.3
          cd ..

          # à§ª. JSON à¦à¦¬à¦‚ Keystore à¦«à¦¿à¦°à¦¿à§Ÿà§‡ à¦†à¦¨à¦¾
          mkdir -p android/app
          mv ./google-services.json.backup android/app/google-services.json || echo "No JSON found"

          keytool -genkey -v -keystore android/app/upload-keystore.jks \
            -storepass "pagla123" -alias "pagla_alias" -keypass "pagla123" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Pagla, O=Chat, C=BD" -startdate "2024/01/01 00:00:00"

          # à§«. à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§‡à¦‡ à¦šà¦¿à¦°à¦šà§‡à¦¨à¦¾ à¦•à¦¨à¦«à¦¿à¦—à¦¾à¦°à§‡à¦¶à¦¨
          sed -i 's/minSdkVersion .*/minSdkVersion 21/g' android/app/build.gradle
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          chmod +x android/gradlew

      - name: Build APK (Release)
        run: |
          flutter pub get
          flutter build apk --release --no-tree-shake-icons

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PaglaChat-Final-Working
          path: build/app/outputs/flutter-apk/app-release.apk
