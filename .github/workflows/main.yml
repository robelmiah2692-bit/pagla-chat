name: Build APK
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          cache: true

      - name: üõ†Ô∏è Reconstruction & Firebase Link (Logic 170)
        run: |
          # ‡ßß. ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ
          sed -i 's/name: .*/name: pagla_chat/g' pubspec.yaml
          
          # ‡ß®. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶° ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶∞‡ßá ‡¶§‡ßà‡¶∞‡¶ø (‡¶∏‡¶´‡¶≤ ‡ßß‡ß≠‡ß¶ ‡¶è‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï)
          rm -rf android
          flutter create . --project-name pagla_chat --platforms android
          
          # ‡ß©. ‡¶∏‡¶¨ ‡¶™‡ßç‡¶≤‡¶æ‡¶ó‡¶á‡¶® ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤
          flutter pub get
          
          # ‡ß™. ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶Ö‡¶ü‡ßã-‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü (‡¶™‡ßç‡¶≤‡¶æ‡¶ó‡¶á‡¶® ‡¶á‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®)
          sed -i '/dependencies {/a \        classpath "com.google.gms:google-services:4.3.15"' android/build.gradle
          echo "apply plugin: 'com.google.gms.google-services'" >> android/app/build.gradle
          
          # ‡ß´. ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ (minSdkVersion 21)
          sed -i 's/minSdkVersion .*/minSdkVersion 21/g' android/app/build.gradle
          echo "android.useAndroidX=true" > android/gradle.properties
          echo "android.enableJetifier=true" >> android/gradle.properties
          
          # ‡ß¨. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶™‡¶æ‡¶• ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶®
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=/opt/hostedtoolcache/flutter/stable-3.19.0-x64" >> android/local.properties
          chmod +x android/gradlew

      - name: üîë Key Store & SHA Output (Firebase Ready)
        run: |
          mkdir -p android/app
          # ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶ï‡¶ø-‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø
          keytool -genkey -v -keystore android/app/upload-keystore.jks \
            -storepass "pagla123" -alias "pagla_alias" -keypass "pagla123" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Pagla, O=Chat, C=BD" || true
            
          cd android
          # SHA ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶™‡ßá‡¶ú‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
          ./gradlew signingReport > sha_report.txt
          echo "### üîë ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ SHA-1 ‡¶ï‡ßã‡¶° ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 5 "Variant: release" sha_report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # ‡¶≤‡¶ó‡ßá‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
          echo "**************************************************"
          grep -A 5 "Variant: release" sha_report.txt
          echo "**************************************************"

      - name: Build APK (Release)
        run: |
          # ‡¶á‡¶â‡¶ü‡¶ø‡¶â‡¶¨, ‡¶Ü‡¶ó‡ßã‡¶∞‡¶æ ‡¶∏‡¶¨ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶∏‡¶π ‡¶¨‡¶ø‡¶≤‡ßç‡¶°
          flutter build apk --release --no-tree-shake-icons

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PaglaChat-Final-Build
          path: build/app/outputs/flutter-apk/app-release.apk
